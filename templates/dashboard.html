<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zone Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/toast.css') }}">

  <!-- Preconnect to CDNs for faster loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.plot.ly">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">

  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/heatmap.js" defer></script>

  <!-- Plotly.js for advanced charts -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js" defer></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>




</head>
<body>
  <!-- Header -->
  <header>
    <nav class="navbar navbar-dark bg-dark px-4 shadow-sm">
      <div class="d-flex align-items-center">
        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="logo" width="32" height="32" class="me-2">
        <span class="navbar-brand mb-0 h1">Crowd Count Dashboard</span>
          <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
          <li><a href="{{ url_for('auth.profile') }}" class="nav-link px-2 text-secondary">Profile</a></li>
          <!-- <li><a href="#" class="nav-link px-2 text-white">Features</a></li> -->
          <li><a href="{{ url_for('dashboard.dashboard') }}" class="nav-link px-2 text-white">Feed Management</a></li>
          <!-- <li><a href="#" class="nav-link px-2 text-white">Analytics</a></li>

          <li><a href="#" class="nav-link px-2 text-white">About</a></li> -->
          <li><button class="nav-link px-2 text-secondary bg-transparent border-0" data-bs-toggle="modal" data-bs-target="#settingsModal">Setting</button></li>
        </ul>

      </div >
      <div class="text-end">
      <span class="text-light me-2 ">Hi, {{ session.username }}!</span>
      <button id="signOutBtn" class="btn btn-outline-light btn-sm ">Sign Out</button>
      </div>
    </nav>
  </header>

  <!-- Main Container -->
  <div id="container">
    <div class="content">
      <!-- Sidebar -->
      <aside class="shadow-sm" style="max-width: 400px; flex-shrink: 0;">

        <button id="toggleSidebarBtn" class="btn btn-outline-secondary btn-sm" title="Toggle Sidebar" style="z-index: 1000;"></button>
        <div class  ="sidebar-content">
        <h2>Feeds</h2>
        <ul id="feedList" class="list-group list-group-flush mb-3"></ul>
        <button id="addFeedBtn" class="btn btn-primary btn-sm mb-3">+ Add Feed</button>

        <div id="feedTypeSelector" style="display:none; margin-top:15px;">
          <label>Feed Name:<br />
            <input type="text" id="newFeedName" class="form-control form-control-sm" />
          </label>
          <label>Feed Type:<br />
            <select id="newFeedType" class="form-select form-select-sm">
              <option value="camera">Camera Feed</option>
              <option value="video">Video Feed</option>
            </select>
          </label>
          <div id="videoUploadContainer" style="display:none;">
            <label>Upload Video:<br />
              <input type="file" id="videoUploadInput" class="form-control form-control-sm" accept="video/*" />
            </label>
          </div>
          <button id="saveFeedBtn" class="btn btn-success btn-sm mt-2">Save Feed</button>
          <button id="cancelFeedBtn" class="btn btn-secondary btn-sm mt-2">Cancel</button>
        </div>
      </div>
      </aside>

      <!-- Main Panel -->
      <main>
        <h2 id="currentFeedTitle">Select or add a feed</h2>
        <button id="eyeBtn" class="btn btn-outline-info btn-sm" style="display: none; margin-bottom: 10px;">
          üëÅÔ∏è Camera Preview: ON
        </button>

        <nav id="feedTabs" style="display:none">
          <button data-tab="draw" class="tabBtn active">Draw Zones</button>
          <button data-tab="preview" class="tabBtn">Preview Zones</button>
          <button data-tab="update" class="tabBtn">Update/Delete Zones</button>
          <button data-tab="analysis" class="tabBtn">Analysis</button>
          <button data-tab="analysis-preview" class="tabBtn">Anaytics Preview </button>
          
        </nav>

        <!-- Draw Zones Tab -->
        <section id="tab-draw" class="tab-content" style="display:block;">
          <div class="card p-3 shadow-sm">
            <h3>Draw Zones</h3>
            <div class="row">
              <div class="col-md-7">
                <div id="videoContainer" class="mb-4">
                  <video id="video" muted playsinline autoplay loop></video>
                  <canvas id="canvas" width="640" height="360"></canvas>
                </div>
              </div>
              <div class="col-md-5">
                <div class="card p-3 shadow-sm rounded-4" style="background-color: rgba(255, 255, 255, 0.3); backdrop-filter: blur(3px); border: 1px solid rgba(255,255,255,0.2);">
                  <h4>Instructions</h4>
                  <h5> How to Draw Zones</h5>
                  <ol>
                    <li>Firstly, Click "Start Drawing".</li>
                    <li>Enter a zone label.</li>
                    <li>Now, draw a zone in the video preview.</li>
                    <li>Click "Save Zones".</li>
                  </ol>
                  <p><strong>Tips:</strong> Cover crowd areas, avoid overlaps, preview in "Preview Zones".</p>
                </div>
              </div>
                
                <!-- <label>Zone Label:
                  <input type="text" id="zoneLabel" class="form-control form-control-sm" placeholder="Enter zone label" />
                </label> -->
                 <label class="input-group">
                  <span class="input-group-text" id="basic-addon3">Zone Label:</span>
                  <input type="text" id="zoneLabel" class="form-control form-control-sm" placeholder="Enter zone label" />
                </label>


                <div class="mt-2">
                  <button id="startDrawingBtn" class="btn btn-primary btn-sm">Start Drawing</button>
                  <button id="cancelDrawingBtn" class="btn btn-secondary btn-sm" disabled>Cancel Drawing</button>
                </div>
                <div class="mt-3">
                  <button id="saveZonesBtn" class="btn btn-success btn-sm"> +  Save Zones</button>
                  <button id="stopAnalysisBtnDraw" class="btn btn-danger btn-sm" style="display:none;">Stop Analysis</button>
                </div>
                <div id="crowdCountsDraw" class="mt-3"></div>
              <!-- </div> -->

            </div>
          </div>
        </section>

        <!-- Preview Zones Tab -->
        <section id="tab-preview" class="tab-content" style="display:none;">
          <div class="card p-3 shadow-sm">
            <h3>Preview Zones</h3>
            <div id="previewVideoContainer">
              <video id="previewVideo" muted playsinline autoplay></video>
              <canvas id="previewCanvas" width="640" height="360"></canvas>
            </div>
          </div>
        </section>

        <!-- Update/Delete Zones Tab -->
<section id="tab-update" class="tab-content" style="display: none;">
  <div class="card shadow-sm border-0 p-4">
    <div class="card-body">
      <div id="updateZoneSelect" class="row align-items-center gy-3">

        <!-- Left: Label -->
        <div class="col-12 col-md-3 text-md-end justify-content-start text-center">
          <label for="zonesDropdown" class="form-label mb-0">Select Zone:</label>
        </div>

        <!-- Center: Dropdown -->
        <div class="col-12 col-md-5 d-flex justify-content-center">
          <div class="w-100" style="max-width: 300px;">
            <select id="zonesDropdown" class="form-select">
              <option selected disabled>-- Choose a zone --</option>
            </select>
          </div>
        </div>

        <!-- Right: Buttons -->
        <div class="col-12 col-md-4 text-center text-md-start">
          <div class="d-flex justify-content-center justify-content-md-start gap-2">
            <button id="modifyZoneBtn" class="btn btn-warning">
              <i class="fa-regular fa-pen-to-square" style="color: #ffffff;"></i>&nbsp; Modify
            </button>
            <button id="deleteZoneBtn" class="btn btn-danger">
              <i class="fa-solid fa-trash" style="color: #ffffff;"> </i>&nbsp;   Delete
            </button>
          </div>
        </div>

      </div>

      <div id="modifyZoneForm" style="display: none;">
        <h4>Modify Zone</h4>
        <div class="row">
          <div class="col-md-6">
            <label for="modifyLabel" class="form-label">Label</label>
            <input type="text" id="modifyLabel" class="form-control">
          </div>
        </div>
        <h5>Coordinates</h5>
        <div class="row">
          <div class="col-md-3">
            <label for="modifyTLX" class="form-label">Top Left X</label>
            <input type="number" id="modifyTLX" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="modifyTLY" class="form-label">Top Left Y</label>
            <input type="number" id="modifyTLY" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="modifyTRX" class="form-label">Top Right X</label>
            <input type="number" id="modifyTRX" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="modifyTRY" class="form-label">Top Right Y</label>
            <input type="number" id="modifyTRY" class="form-control">
          </div>
        </div>
        <div class="row">
          <div class="col-md-3">
            <label for="modifyBRX" class="form-label">Bottom Right X</label>
            <input type="number" id="modifyBRX" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="modifyBRY" class="form-label">Bottom Right Y</label>
            <input type="number" id="modifyBRY" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="modifyBLX" class="form-label">Bottom Left X</label>
            <input type="number" id="modifyBLX" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="modifyBLY" class="form-label">Bottom Left Y</label>
            <input type="number" id="modifyBLY" class="form-control">
          </div>
        </div>
        <div class="mt-3">
          <button id="saveModifyBtn" class="btn btn-success">Save Changes</button>
          <button id="cancelModifyBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</section>



        <!-- Analysis Tab -->
      <section id="tab-analysis" class="tab-content" style="display:none;">
  <div>
    <h3 class="mb-4">Analysis</h3>
    <div class="row gx-4 gy-4"> <!-- Adds horizontal & vertical spacing -->

      <!-- Left: Video Card -->
      <div class="col-md-7">
        <div class="card p-3 shadow-sm rounded-4 h-100" style = "min-width: 680px; height: 360px;"> <!-- More rounded -->
          <div id="analysisVideoContainer"  class="position-relative">
            <img id="analysisVideo" class="w-100 rounded-3" style="max-height: 360px;">
            <canvas id="analysisCanvas" width="640" height="360" class="position-absolute top-0 start-0 w-100 h-100"></canvas>
            <div id="analysisLoading" class="position-absolute top-50 start-50 translate-middle" style="display:none; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 8px #515252, 0 0 20px rgba(118, 132, 135, 0.5); ">
              <div class="spinner-border spinner-border-sm me-2" role="status"></div>
              Starting Analysis...
            </div>
          </div>
          <div class="mt-3">
            <button id="startAnalysisBtn" class="btn btn-primary btn-sm">Start Analysis</button>
            <button id="stopAnalysisBtn" class="btn btn-danger btn-sm" style="display:none;">Stop Analysis</button>
            <button id="toggleHeatmapBtn" class="btn btn-secondary btn-sm ms-2" style="display:none;">Toggle Heatmap</button>
            <button id="toggleDeepsortBtn" class="btn btn-secondary btn-sm ms-2" style="display:none;">Toggle Deepsort</button>
            <button id="generateReportBtn" class="btn btn-secondary btn-sm ms-2"style="display: none;">Generate Report</button>
          </div>
        </div>
      </div>

    
      <!-- Right: Count + Charts Card -->
      <div class="col-md-5">
        <div class="card p-3 shadow-sm rounded-4" style="background-color: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);"> <!-- More rounded, no height stretch -->

          <!-- Crowd Count -->
          <div id="crowdCounts" class="mb-3" >
            <p id="videoCount" class="mb-1 " style = "font-weight: bold;">Video Count: 0</p>
            <div id="zoneCounts"></div>
            <!-- <div id="heatmapBox" style="border: 1px solid #ccc; padding: 8px; margin-top: 8px;">
              <strong>Heatmap</strong>
              <canvas id="heatmapCanvas" width="300" height="200"></canvas>
            </div> -->
          </div>

          <!-- Alert -->
          <div id="alertContainer" style="display:none;">
            <div class="alert alert-danger" role="alert">
              <h5>‚ö†Ô∏è ALERT: Zone Population Exceeded!</h5>
              <div id="alertMessage"></div>
            </div>
          </div>

          <!-- Zone Chart -->
          <!-- <div class="mt-4">
            <h5>Zone Population Chart</h5>
            <canvas id="zoneChart" width="300" height="200"></canvas>
          </div> -->

          <!-- Trend Chart -->
          <!-- <div class="mt-4">
            <h5>Population Trend</h5>
            <canvas id="trendChart" width="300" height="200"></canvas>
          </div> -->

          <!-- Heatmap -->
          <!-- <div class="mt-4">
            <h5>Heatmap</h5>
            <canvas id="heatmapChartCanvas" width="300" height="200"></canvas>
          </div> -->

        </div>
      </div>

    </div>
  </div>
</section>

        <!-- Analysis Preview Tab -->
        <section id="tab-analysis-preview" class="tab-content" style="display:none;">
          {% include 'tab_analysis_preview.html' %}
        </section>

      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>¬© Crowd Counting Dashboard</p>
  </footer>

  {% include 'settings_modal.html' %}

<!-- Your Custom JS -->
<script src="{{ url_for('static', filename='js/toast.js') }}"></script>
{% if session.get('show_welcome_toast') %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    showToast('message', 'Hello {{ session.username }}, welcome to your Crowd Count Dashboard!');
  });
</script>
{% set _ = session.pop('show_welcome_toast') %}
{% endif %}
<script src="{{ url_for('static', filename='js/visualizations.js') }}"></script>
<script src="{{ url_for('static', filename='js/yolo_analysis.js') }}"></script>
<script src="{{ url_for('static', filename='js/tab_analysis_preview.js') }}"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
<script>
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', () => {
    const navLinks = document.querySelectorAll('.nav-tab');

    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        // Remove 'text-secondary' and add 'text-white' to all
        navLinks.forEach(l => {
          l.classList.remove('text-secondary');
          l.classList.add('text-white');
        });

        // Add 'text-secondary' to the clicked one and remove 'text-white'
        link.classList.add('text-secondary');
        link.classList.remove('text-white');
      });
    });
  });
</script>

</body>
</html>
